# 功能规格说明书：月计划Excel直接排产功能

**功能分支**: `001-aps-v2-2019`  
**创建时间**: 2025-01-16  
**状态**: 草案  
**输入描述**: "输入：@aps_v2/浙江中烟2019年7月份生产计划安排表（6.20）.xlsx，根据给定的计划进行需求细化，计划： 月计划Excel直接排产功能 - 完整技术实现方案（修正版）"

## 执行流程 (主函数)
```
1. 解析用户描述
   → 识别：月计划Excel处理用于烟草生产排产
2. 提取关键概念
   → 参与者：生产计划员，系统操作员
   → 操作：上传Excel，解析数据，生成排产方案，创建工单
   → 数据：月度生产计划，机台分配，工作日历
   → 约束：机台能力，工作日，维修计划
3. 标记不明确的方面
   → [需要澄清：Excel文件的具体格式结构]
   → [需要澄清：具体的烟草产品规格分类]
4. 填写用户场景和测试部分
   → 明确的用户流程：上传→解析→排产→生成→审核
5. 生成功能需求
   → 每个需求都可针对现有系统能力进行测试
6. 识别关键实体
   → 月计划，工作日历，机台排产，工单
7. 运行评审检查清单
   → 规格专注于业务价值，避免实现细节
8. 返回：成功（规格准备就绪，可进入计划阶段）
```

---

## ⚡ 快速指引
- ✅ 关注用户需要什么和为什么需要
- ❌ 避免如何实现（技术栈、API、代码结构）
- 👥 面向业务干系人编写，非开发人员

---

## 用户场景与测试 *(必填)*

### 主要用户故事
生产计划员需要上传月度生产计划Excel文件（.xlsx格式，如"浙江中烟2019年7月份生产计划安排表"），系统自动提取杭州卷烟厂的生产需求，生成详细的机台排产方案和工单，无需手动分配机台。系统应根据产品规格和可用产能智能分配机台，考虑工作日、节假日和维修计划。

根据文件结构分析，月计划表格核心数据为：
- **品牌规格**：如利群系列各种规格（休闲、云端、红利、逍遥等）
- **原计划**：杭州卷烟厂的目标生产箱数
- **范围限制**：仅处理杭州卷烟厂数据，忽略宁波厂、产出比、包装类型等其他列

### 验收场景
1. **给定** 包含品牌规格和原计划数量的.xlsx月计划文件，**当** 用户上传文件时，**那么** 系统仅解析杭州卷烟厂的产品条目并存储为未分配的生产需求
2. **给定** 解析的杭州厂生产需求，**当** 用户启动排产时，**那么** 系统按算法规则自动分配：
   - 查询aps_machine_speed表找到可生产该品牌规格的机台
   - 计算所需生产时间 = 原计划箱数 ÷ 机台小时产能
   - 基于工作日历分配具体时间段
   - 生成带有开始/结束时间的工单
3. **给定** 生成的排产方案，**当** 用户查看计划时，**那么** 系统显示甘特图展示每台机台的时间占用和产品分配
4. **给定** 确认的排产方案，**当** 用户生成工单时，**那么** 系统创建包含机台代码、产品规格、数量、时间段的详细工单

### 算法示例场景
- **场景A**: 利群(休闲)需要生产1000箱，系统找到J01机台（100箱/小时），计算需要10小时，安排在7月1日08:00-18:00生产
- **场景B**: 当J01机台已排满时，系统自动选择J02机台（90箱/小时），重新计算时间为11.1小时，向上取整为12小时
- **场景C**: 某产品需求5000箱，单台机台月产能4000箱，系统自动拆分为两台机台各生产2500箱

### 边界情况
- 上传的Excel文件格式不标准或杭州厂数据缺失时会发生什么？
- 杭州厂生产目标超过可用机台产能时系统如何处理？
- 国定假日或延长维修期间会发生什么？
- 多个品牌规格竞争同一机台时间段时如何解决冲突？
- Excel文件中杭州厂原计划列为空或0时如何处理？
- 机台维修期间已安排的生产任务如何重新分配？

## Requirements *(mandatory)*

## 功能需求 *(必填)*

### 功能需求
- **FR-001**: 系统必须接受.xlsx格式的月度生产计划文件，识别品牌规格和杭州厂原计划数量
- **FR-002**: 系统必须解析Excel数据，专门提取杭州卷烟厂的品牌规格和原计划列数据
- **FR-003**: 系统必须维护包含假日、周末和维修计划的工作日历
- **FR-004**: 系统必须基于品牌规格和机台能力自动选择最优机台
- **FR-005**: 系统必须基于机台速度和原计划数量计算生产时间需求
- **FR-006**: 系统必须考虑工作日历约束和现有机台排产分配时间段
- **FR-007**: 系统必须为卷包机和喂丝机生成工单
- **FR-008**: 系统必须通过甘特图提供可视化排产显示，展示机台利用率
- **FR-009**: 系统必须允许初次生成后进行排产修改和重新优化
- **FR-010**: 系统必须与现有MES系统集成进行工单调度
- **FR-011**: 系统必须与现有旬计划功能完全分离，避免冲突
- **FR-012**: 系统必须支持基于优先级的紧急生产需求排产
- **FR-013**: 系统必须忽略非杭州厂的数据列（宁波厂、产出比、包装类型等）
- **FR-014**: 系统必须过滤掉原计划为空或0的产品条目
- **FR-015**: 系统必须处理Excel中的合并单元格和复杂表格格式

### 排产算法具体规则
基于现有数据表结构和完整技术实现方案：

- **ALG-001**: **机台选择算法**：查询`aps_machine_speed`表，根据`article_nr`(品牌规格)匹配`machine_code`，选择`speed`最高且`status='ACTIVE'`的机台
- **ALG-002**: **时间计算算法**：生产时间(小时) = `target_quantity` ÷ (`speed` × `efficiency_rate`/100)，向上取整到最小时间单位
- **ALG-003**: **工作日历算法**：基于新建`aps_work_calendar`表，只在`is_workday=1`且`day_type='WORKDAY'`的日期安排生产
- **ALG-004**: **维修约束算法**：查询`aps_maintenance_plan`表，在`maint_start_time`到`maint_end_time`期间该`machine_code`不可用
- **ALG-005**: **班次约束算法**：结合`aps_shift_config`表，生产时间必须在`start_time`到`end_time`范围内
- **ALG-006**: **时间分配算法**：从`plan_month`第一个工作日开始，按优先级顺序分配时间段，确保无机台冲突
- **ALG-007**: **负载均衡算法**：当多个机台可生产同一`article_nr`时，选择当前已分配工作量最少的机台
- **ALG-008**: **产能拆分算法**：当`target_quantity`超过单台机台月产能时，按比例拆分到多台机台，存储为多条`aps_monthly_schedule_result`记录
- **ALG-009**: **时间窗口算法**：确保每个`planned_start_time`到`planned_end_time`不与同机台其他任务重叠

### 数据表依赖关系
**现有表**：
- `aps_machine_speed`: 机台-产品速度配置 (article_nr → machine_code + speed)
- `aps_maintenance_plan`: 维修计划约束
- `aps_shift_config`: 班次时间约束
- `aps_machine_relation`: 机台关系(卷包机-喂丝机配对)

**新建表**：
- `aps_work_calendar`: 工作日历(核心依赖)
- `aps_monthly_plan`: 月计划基础数据
- `aps_monthly_schedule_result`: 排产结果

### 算法执行流程
1. **Excel解析** → 提取杭州厂`article_nr` + `target_quantity` → 存入`aps_monthly_plan`
2. **机台匹配** → 从`aps_machine_speed`查询可用机台列表
3. **时间计算** → 基于`speed`和`efficiency_rate`计算所需生产时间
4. **约束检查** → 检查`aps_work_calendar`、`aps_maintenance_plan`、`aps_shift_config`
5. **时间分配** → 分配具体`planned_start_time`和`planned_end_time`
6. **结果存储** → 生成`aps_monthly_schedule_result`记录
7. **工单生成** → 转换为MES兼容的工单格式

*需要澄清的：*
- **ALG-010**: 优先级排序规则 [需要澄清：`aps_monthly_plan.priority_level`的具体排序逻辑]
- **ALG-011**: 产能溢出处理策略 [需要澄清：总需求超过月产能时的处理方式]
- **ALG-012**: 机台关系处理 [需要澄清：是否需要考虑`aps_machine_relation`中的卷包机-喂丝机配对约束]

### 关键实体 *(涉及数据时填写)*
基于完整技术实现方案的数据模型：

**新建实体**：
- **月计划** (`aps_monthly_plan`): 存储Excel解析后的杭州厂生产需求，包含`article_nr`、`target_quantity`、`plan_month`等字段
- **工作日历** (`aps_work_calendar`): 核心时间约束，包含`calendar_date`、`is_workday`、`day_type`、`holiday_name`
- **月计划排产结果** (`aps_monthly_schedule_result`): 算法生成的排产方案，包含`machine_code`、`allocated_quantity`、`planned_start_time`、`planned_end_time`

**现有实体依赖**：
- **机台速度配置** (`aps_machine_speed`): 通过`article_nr`匹配`machine_code`和`speed`，支持机台选择算法
- **维修计划** (`aps_maintenance_plan`): 提供`maint_start_time`到`maint_end_time`的机台不可用时间窗口
- **班次配置** (`aps_shift_config`): 定义每日生产时间范围`start_time`到`end_time`
- **机台关系** (`aps_machine_relation`): 卷包机与喂丝机的配对关系约束

### 技术架构对应
按8个开发阶段的完整实现方案：

**Phase 1**: 3个新数据表设计 (`aps_work_calendar`, `aps_monthly_plan`, `aps_monthly_schedule_result`)  
**Phase 2**: 7个独立算法模块 (`monthly_scheduling/`目录下)  
**Phase 3**: Excel解析器 (处理杭州厂数据提取)  
**Phase 4**: SQLAlchemy模型 (`monthly_plan_models.py`)  
**Phase 5**: 5个独立API端点 (`/api/v1/monthly-plans/*`)  
**Phase 6**: 前端Tab界面 (旬计划/月计划切换)  
**Phase 7**: 工作日历数据初始化 (2024-2026年)  
**Phase 8**: 端到端集成测试

---

## 评审与验收检查清单
*关卡：主函数执行期间运行的自动化检查*

### 内容质量
- [x] 无实现细节（编程语言、框架、API）
- [x] 专注于用户价值和业务需求
- [x] 面向非技术干系人编写
- [x] 所有必填部分已完成

### 需求完整性
- [ ] 没有[需要澄清]标记残留
- [x] 需求可测试且无歧义
- [x] 成功标准可衡量
- [x] 范围边界清晰
- [x] 依赖和假设已识别

---

## 执行状态
*主函数处理期间更新*

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 模糊性已标记
- [x] 用户场景已定义
- [x] 需求已生成
- [x] 实体已识别
- [ ] 评审检查清单通过（待澄清事项）

---
