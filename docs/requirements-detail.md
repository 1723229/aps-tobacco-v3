# APS智慧排产系统 - 需求细化文档

## 1. 功能需求矩阵

### 1.1 核心功能需求

| 功能模块 | 功能子项 | 优先级 | 实现复杂度 | 依赖关系 | 验收标准 |
|---------|---------|--------|------------|----------|----------|
| **数据导入管理** | Excel文件上传 | P0 | 简单 | 无 | 支持.xlsx格式，文件大小≤10MB |
| | 数据解析验证 | P0 | 中等 | 文件上传 | 数据结构验证通过率100% |
| | 数据入库存储 | P0 | 简单 | 数据解析 | 数据完整性和一致性验证 |
| **排产算法引擎** | 规则合并处理 | P0 | 复杂 | 数据入库 | 按PRD规则正确合并旬计划 |
| | 规则拆分处理 | P0 | 复杂 | 规则合并 | 按机台数量正确拆分工单 |
| | 时间校正算法 | P0 | 复杂 | 规则拆分 | 考虑轮保、班次等因素 |
| | 并行切分算法 | P0 | 复杂 | 时间校正 | 实现同时开始同时结束 |
| **工单生成** | 卷包机工单生成 | P0 | 中等 | 并行切分 | 工单数据准确完整 |
| | 喂丝机工单生成 | P0 | 中等 | 并行切分 | 工单数据准确完整 |
| | 备用工单处理 | P1 | 中等 | 工单生成 | 跨月份牌号变更处理 |
| **MES集成** | 工单导出接口 | P0 | 中等 | 工单生成 | 符合MES接口规范 |
| | 状态同步接口 | P1 | 中等 | MES集成 | 实时状态更新 |
| **结果查看** | 排产结果展示 | P0 | 简单 | 工单生成 | 清晰直观的结果显示 |
| | 数据查询筛选 | P1 | 简单 | 结果展示 | 多维度筛选查询 |
| | 报表导出 | P1 | 简单 | 结果展示 | 支持Excel导出 |
| **基础配置** | 主数据管理 | P0 | 简单 | 无 | 机台、物料等基础数据 |
| | 业务规则配置 | P1 | 中等 | 主数据管理 | 可配置业务参数 |
| | 工作日历管理 | P1 | 中等 | 主数据管理 | 班次、假期等配置 |

**优先级说明：**
- P0：核心功能，必须实现
- P1：重要功能，首版可选实现
- P2：一般功能，后续版本实现

### 1.2 非功能性需求

| 需求类型 | 具体要求 | 验收标准 |
|---------|----------|----------|
| **性能要求** | 文件上传响应时间 | ≤30秒(10MB文件) |
| | 排产算法执行时间 | ≤5分钟(1000条记录) |
| | 页面加载时间 | ≤3秒(正常网络环境) |
| | 并发用户数 | 支持3个并发用户 |
| **可靠性要求** | 系统可用性 | ≥99.5% |
| | 数据完整性 | 100%(无数据丢失) |
| | 算法准确性 | 100%(按业务规则执行) |
| **安全性要求** | 数据传输加密 | HTTPS协议 |
| | 数据存储安全 | 数据库加密存储 |
| | 操作日志记录 | 所有操作可追溯 |
| **兼容性要求** | 浏览器支持 | Chrome 80+, Firefox 75+, Edge 80+ |
| | 操作系统支持 | Windows 10, macOS 10.15+ |
| | 数据库支持 | MySQL 8.0+|

## 2. 详细业务规则

### 2.1 数据导入规则

#### 2.1.1 文件格式要求

**支持格式：** Excel (.xlsx)

**必填字段验证：**
- 生产订单号 (WorkOrderNr)：非空，长度≤20字符
- 成品烟牌号 (ArticleNr)：非空，长度≤50字符  
- 投料总量 (QuantityTotal)：正整数，>0
- 成品数量 (FinalQuantity)：正整数，>0
- 卷包机代码 (MakerCode)：非空，长度≤20字符
- 喂丝机代码 (FeederCode)：非空，长度≤20字符
- 计划开始时间 (PlannedStart)：有效日期时间格式
- 计划结束时间 (PlannedEnd)：有效日期时间格式，须>开始时间

**业务规则验证：**
- 开始时间必须早于结束时间
- 同一机台在同一时间段不能有重复安排
- 投料总量与成品数量的比例须在合理范围内(0.8-1.2)

#### 2.1.2 数据解析规则

**重复数据处理：**
- 相同订单号+机台代码+时间的记录视为重复
- 重复数据仅保留最后一条记录
- 系统提示重复数据处理结果

**异常数据处理：**
- 数据格式错误：标记为错误，不导入
- 业务规则违反：标记为警告，可选择性导入
- 完全空行：自动忽略

### 2.2 排产合并规则

#### 2.2.1 合并条件

**合并判定条件（需全部满足）：**
1. 旬计划在同一个月份内
2. 成品烟牌号相同
3. 卷包机代码相同  
4. 喂丝机代码相同

#### 2.2.2 合并属性计算

**时间属性：**
- 计划开始时间 = Min(所有待合并记录的开始时间)
- 计划结束时间 = Max(所有待合并记录的结束时间)

**数量属性：**
- 投料总量 = Sum(所有待合并记录的投料总量)
- 成品数量 = Sum(所有待合并记录的成品数量)

**标识属性：**
- 生产订单号 = 生成新的合并订单号(格式：M{YYYYMMDD}{序号})
- 机台代码 = 保持不变

### 2.3 排产拆分规则

#### 2.3.1 拆分触发条件

**需要拆分的情况：**
- 一个喂丝机对应多台卷包机
- 工单数量超过单台机台处理能力
- 时间跨度超过单个班次时长

#### 2.3.2 拆分算法

**数量分配原则：**
- 按卷包机数量平均分配投料总量
- 如有余数，按机台编号顺序分配
- 确保每台机台分配量>0

**时间分配原则：**
- 所有拆分后的工单保持相同开始和结束时间
- 符合"同时开始，同时结束"原则

**工单编号规则：**
- 拆分工单编号格式：{原订单号}-{机台序号}
- 例：W0001拆分后为W0001-01, W0001-02

### 2.4 时间校正规则

#### 2.4.1 轮保时间处理

**轮保信息来源：** MES系统接口

**校正算法：**
1. 获取计划时间段内的轮保计划
2. 如开始时间冲突，延后到轮保结束后
3. 如结束时间冲突，提前到轮保开始前
4. 重新计算实际可生产时间

**轮保冲突处理：**
- 完全覆盖：整个工单延期到轮保后
- 部分覆盖：调整时间避开轮保时段
- 多段轮保：选择最优时间窗口

#### 2.4.2 班次时间处理

**班次定义：**
- 早班：6:40-15:40
- 中班：15:40-24:00

**跨班次处理：**
- 工单时间不允许跨越非连续班次
- 如需跨班，在班次间隔时暂停
- 加班时间按实际班次设置处理

### 2.5 并行处理规则

#### 2.5.1 并行约束条件

**同一工单约束：**
- 同一工单下所有卷包机必须同时开始
- 同一工单下所有卷包机必须同时结束
- 喂丝机开始时间≤所有卷包机开始时间

**不同工单约束：**
- 同一喂丝机的不同工单不能时间重叠
- 同一卷包机的不同工单不能时间重叠
- 前一工单结束后至少间隔15分钟才能开始下一工单

#### 2.5.2 并行优化策略

**时间窗口优化：**
- 寻找最优的共同时间窗口
- 最小化总体完工时间
- 最大化机台利用率

**冲突解决策略：**
1. 优先级高的工单优先安排
2. 紧急工单可插队处理
3. 无法并行时顺序执行

### 2.6 工单生成规则

#### 2.6.1 卷包机工单生成

**工单属性：**
- 工单号：系统自动生成(格式：JJ{YYYYMMDD}{序号})
- 机台代码：对应的卷包机代码
- 数量分配：按拆分算法分配的数量
- 时间安排：校正后的开始和结束时间

**特殊工单处理：**
- 备用工单：跨月份且牌号不同时生成
- 补料工单：原料不足时自动生成补料工单
- 调整工单：计划变更时生成调整工单

#### 2.6.2 喂丝机工单生成

**工单属性：**
- 工单号：系统自动生成(格式：FF{YYYYMMDD}{序号})  
- 机台代码：对应的喂丝机代码
- 总供料量：对应所有卷包机的总需求量
- 时间安排：覆盖所有对应卷包机的时间范围

**供料计算：**
- 供料量 = Sum(所有对应卷包机的投料需求)
- 增加5%安全库存
- 考虑物料损耗率(根据历史数据)

### 2.7 异常处理规则

#### 2.7.1 数据异常

**处理级别：**
- 错误级(Error)：阻断流程，必须修复
- 警告级(Warning)：不阻断，但需确认
- 信息级(Info)：正常提示信息

**常见异常类型：**
- 数据格式错误：提示具体错误字段和原因
- 业务规则冲突：显示冲突详情和建议方案
- 系统资源不足：提示稍后重试或联系管理员

#### 2.7.2 算法异常

**超时处理：**
- 排产算法执行超时(>10分钟)自动终止
- 保存中间结果，支持断点续算
- 提供简化算法选项

**无解处理：**
- 约束条件过于严格导致无可行解
- 提供约束条件放松建议
- 支持手工调整后重新计算

### 2.8 质量控制规则

#### 2.8.1 数据质量检查

**完整性检查：**
- 必填字段完整性验证
- 关联数据一致性验证
- 时间序列连续性验证

**准确性检查：**
- 数值范围合理性验证
- 时间逻辑合理性验证
- 业务规则符合性验证

#### 2.8.2 结果质量验证

**算法结果验证：**
- 工单总量与输入计划一致
- 时间安排无冲突
- 机台负荷在合理范围内

**导出数据验证：**
- MES接口数据格式正确
- 必填字段无缺失
- 数据编码格式正确

## 3. 接口需求规范

### 3.1 MES系统接口

#### 3.1.1 轮保计划接口(输入)

**接口名称：** getMaintPlan
**调用方式：** RESTful API / HTTP GET
**数据格式：** JSON

**请求参数：**
```json
{
  "startDate": "YYYY-MM-DD",
  "endDate": "YYYY-MM-DD", 
  "machineCode": "string|optional"
}
```

**响应数据：**
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "maintPlanNo": "MP001",
      "scheduleTime": "YYYY-MM-DD",
      "shift": "1|2|3",
      "maintGroup": "1|2|3",
      "planner": "string",
      "equipmentPosition": "string"
    }
  ]
}
```

#### 3.1.2 工单下发接口(输出)

**接口名称：** sendWorkOrder
**调用方式：** RESTful API / HTTP POST
**数据格式：** JSON

**卷包机工单数据：**
```json
{
  "workOrderType": "PACKING",
  "workOrderNr": "string",
  "articleNr": "string", 
  "quantityTotal": 0,
  "finalQuantity": 0,
  "makerCode": "string",
  "plannedStart": "YYYY-MM-DD HH:mm:ss",
  "plannedEnd": "YYYY-MM-DD HH:mm:ss"
}
```

**喂丝机工单数据：**
```json
{
  "workOrderType": "FEEDING",
  "workOrderNr": "string",
  "articleNr": "string",
  "quantityTotal": 0,
  "feederCode": "string", 
  "plannedStart": "YYYY-MM-DD HH:mm:ss",
  "plannedEnd": "YYYY-MM-DD HH:mm:ss"
}
```

### 3.2 文件上传接口

#### 3.2.1 文件上传

**接口路径：** /api/upload/plan
**请求方式：** POST
**内容类型：** multipart/form-data

**请求参数：**
- file：Excel文件(.xlsx)
- planType：计划类型(DECADE_PLAN)

**响应数据：**
```json
{
  "code": 200,
  "message": "upload success",
  "data": {
    "fileId": "string",
    "fileName": "string",
    "fileSize": 0,
    "uploadTime": "YYYY-MM-DD HH:mm:ss"
  }
}
```

### 3.3 排产执行接口

#### 3.3.1 启动排产

**接口路径：** /api/scheduling/start
**请求方式：** POST
**请求参数：**
```json
{
  "fileId": "string",
  "schedulingParams": {
    "mergeEnabled": true,
    "splitEnabled": true,
    "correctionEnabled": true,
    "parallelEnabled": true
  }
}
```

**响应数据：**
```json
{
  "code": 200,
  "message": "scheduling started",
  "data": {
    "taskId": "string",
    "status": "RUNNING"
  }
}
```

#### 3.3.2 查询排产状态

**接口路径：** /api/scheduling/status/{taskId}
**请求方式：** GET

**响应数据：**
```json
{
  "code": 200, 
  "data": {
    "taskId": "string",
    "status": "RUNNING|COMPLETED|FAILED",
    "progress": 75,
    "currentStage": "PARALLEL_PROCESSING",
    "startTime": "YYYY-MM-DD HH:mm:ss",
    "endTime": "YYYY-MM-DD HH:mm:ss",
    "errorMessage": "string|null"
  }
}
```

## 4. 数据验收标准

### 4.1 输入数据验收

| 验收项 | 验收标准 | 测试方法 |
|-------|----------|----------|
| 文件格式 | 只接受.xlsx格式 | 上传其他格式文件，验证拒绝 |
| 文件大小 | ≤10MB | 上传超大文件，验证拒绝 |
| 必填字段 | 100%字段非空 | 空字段验证，提示错误 |
| 数据类型 | 严格按字段类型验证 | 错误类型数据验证 |
| 时间逻辑 | 开始时间<结束时间 | 时间倒置数据验证 |

### 4.2 算法结果验收

| 验收项 | 验收标准 | 测试方法 |
|-------|----------|----------|
| 数量守恒 | 输出总量=输入总量 | 数量对比验证 |
| 时间无冲突 | 同机台工单时间无重叠 | 时间冲突检查 |
| 并行约束 | 同工单机台同时开始结束 | 并行约束验证 |
| 业务规则 | 100%符合PRD规则 | 业务规则逐项检查 |

### 4.3 输出数据验收

| 验收项 | 验收标准 | 测试方法 |
|-------|----------|----------|
| MES接口格式 | 100%符合接口规范 | 接口格式验证 |
| 数据完整性 | 所有必填字段无缺失 | 数据完整性检查 |
| 编码格式 | UTF-8编码，无乱码 | 编码格式验证 |

## 5. 系统边界和限制

### 5.1 功能边界

**系统包含的功能：**
- 卷包旬计划数据导入处理
- 排产算法执行(合并、拆分、校正、并行)
- 工单生成和MES导出
- 结果查询和报表展示

**系统不包含的功能：**
- 制丝排产(本系统仅处理卷包排产)
- 用户权限管理(首版不包含)
- 实时生产监控
- 库存管理
- 成本核算

### 5.2 技术限制

**数据量限制：**
- 单次导入文件≤10MB
- 单次处理记录≤10000条
- 历史数据保存≤1年

**性能限制：**
- 并发用户数≤10个
- 算法执行时间≤10分钟
- 文件上传超时≤2分钟

**兼容性限制：**
- 仅支持Excel 2010+格式(.xlsx)
- 仅支持现代浏览器(IE不支持)
- 数据库版本要求MySQL 8.0+

### 5.3 业务限制

**时间限制：**
- 计划时间范围限制在未来6个月内
- 历史计划不允许修改
- 跨年度计划需分年处理

**数据限制：**
- 单个工单最大处理量100万支
- 单台机台最大并行工单数10个
- 班次时间固定，不支持动态调整

## 6. 风险控制要求

### 6.1 数据安全风险

**风险类型：** 数据泄露、数据损坏、数据丢失

**控制措施：**
- 数据传输加密(HTTPS/TLS)
- 数据库访问权限控制
- 定期数据备份(每日)
- 操作日志审计跟踪

### 6.2 业务连续性风险  

**风险类型：** 系统故障、算法错误、接口中断

**控制措施：**
- 系统健康检查和监控
- 算法结果自动验证
- MES接口失败重试机制
- 紧急降级方案(手工处理)

### 6.3 用户操作风险

**风险类型：** 误操作、数据输入错误

**控制措施：**
- 关键操作二次确认
- 数据输入格式验证
- 操作可撤销机制
- 用户操作培训

## 7. 运维要求

### 7.1 监控要求

**系统监控：**
- CPU、内存、磁盘使用率监控
- 数据库连接池监控  
- 应用程序响应时间监控

**业务监控：**
- 文件上传成功率
- 排产算法执行成功率
- MES接口调用成功率

### 7.2 日志要求

**系统日志：**
- 应用程序运行日志
- 数据库操作日志
- 系统错误日志

**业务日志：**
- 用户操作日志
- 数据变更日志
- 接口调用日志

### 7.3 备份要求

**数据备份：**
- 每日增量备份
- 每周全量备份
- 备份数据异地存储

**系统备份：**
- 应用程序代码备份
- 配置文件备份
- 数据库结构备份